<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="作为 AFL  中最重要的一个部分，也就是 fuzzer 实现的关键步骤。因为篇幅太长，会将源码分成好几个模块来介绍 准备工作gettimeofday() 用来获取当前准确时间，接着用 srandom 根据当前时间与当前进程异或之后获取随机种子。 getopt() 函数读取参数并作出相应处理。 setup_signal_handlers()调用sigaction，设置信号处理函数    信号">
<meta property="og:type" content="article">
<meta property="og:title" content="AFL源码分析之afl-fuzz.c">
<meta property="og:url" content="http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/index.html">
<meta property="og:site_name" content="Xu4n">
<meta property="og:description" content="作为 AFL  中最重要的一个部分，也就是 fuzzer 实现的关键步骤。因为篇幅太长，会将源码分成好几个模块来介绍 准备工作gettimeofday() 用来获取当前准确时间，接着用 srandom 根据当前时间与当前进程异或之后获取随机种子。 getopt() 函数读取参数并作出相应处理。 setup_signal_handlers()调用sigaction，设置信号处理函数    信号">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-03-08T07:20:43.000Z">
<meta property="article:modified_time" content="2022-03-11T13:54:52.459Z">
<meta property="article:author" content="Xu4n">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="fuzz">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>AFL源码分析之afl-fuzz.c</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">home</a></li><!--
     --><!--
       --><li><a href="/about/">about</a></li><!--
     --><!--
       --><li><a href="/archives/">articles</a></li><!--
     --><!--
       --><li><a href="/categories/">category</a></li><!--
     --><!--
       --><li><a href="/link/">link</a></li><!--
     --><!--
       --><li><a href="/search/">search</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/makabaka-yyds/makabaka-yyds.github.io">projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/03/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%BF%9B%E5%85%A5%E5%86%85%E6%A0%B8%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/03/06/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-as-c/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&text=AFL源码分析之afl-fuzz.c"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&is_video=false&description=AFL源码分析之afl-fuzz.c"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AFL源码分析之afl-fuzz.c&body=Check out this article: http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&name=AFL源码分析之afl-fuzz.c&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&t=AFL源码分析之afl-fuzz.c"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-signal-handlers"><span class="toc-number">2.</span> <span class="toc-text">setup_signal_handlers()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#check-asan-opts"><span class="toc-number">3.</span> <span class="toc-text">check_asan_opts()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fix-up-sync"><span class="toc-number">4.</span> <span class="toc-text">fix_up_sync()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#save-cmdline"><span class="toc-number">5.</span> <span class="toc-text">save_cmdline()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fix-up-banner"><span class="toc-number">6.</span> <span class="toc-text">fix_up_banner()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#check-if-tty"><span class="toc-number">7.</span> <span class="toc-text">check_if_tty()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%A0%E4%B8%AACPU%E6%A3%80%E6%9F%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">几个CPU检查相关的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-post"><span class="toc-number">9.</span> <span class="toc-text">setup_post()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-shm-%EF%BC%88very-important%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">setup_shm()（very important）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-count-class16"><span class="toc-number">11.</span> <span class="toc-text">init_count_class16()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-dirs-fds"><span class="toc-number">12.</span> <span class="toc-text">setup_dirs_fds()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#read-testcases"><span class="toc-number">13.</span> <span class="toc-text">read_testcases()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load-auto"><span class="toc-number">14.</span> <span class="toc-text">load_auto()</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        AFL源码分析之afl-fuzz.c
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Xu4n</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-03-08T07:20:43.000Z" itemprop="datePublished">2022-03-08</time>
        
        (Updated: <time datetime="2022-03-11T13:54:52.459Z" itemprop="dateModified">2022-03-11</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/PWN/" rel="tag">PWN</a>, <a class="tag-link-link" href="/tags/fuzz/" rel="tag">fuzz</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>  作为 AFL  中最重要的一个部分，也就是 fuzzer 实现的关键步骤。因为篇幅太长，会将源码分成好几个模块来介绍</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>gettimeofday() 用来获取当前准确时间，接着用 srandom 根据当前时间与当前进程异或之后获取随机种子。</p>
<p>getopt() 函数读取参数并作出相应处理。</p>
<h2 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers()"></a>setup_signal_handlers()</h2><p>调用<code>sigaction</code>，设置信号处理函数</p>
<table>
<thead>
<tr>
<th align="left">信号</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SIGHUP/SIGINT/SIGTERM</td>
<td>处理各种“stop”情况</td>
</tr>
<tr>
<td align="left">SIGALRM</td>
<td>处理超时的情况</td>
</tr>
<tr>
<td align="left">SIGWINCH</td>
<td>处理窗口大小</td>
</tr>
<tr>
<td align="left">SIGUSER1</td>
<td>用户自定义信号，这里定义为skip request</td>
</tr>
<tr>
<td align="left">SIGSTP/SIGPIPE</td>
<td>不是很重要的一些信号，可以不用关心</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="keyword">void</span> <span class="title">setup_signal_handlers</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//创建sigaction结构体变量sa</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>;</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler   = <span class="literal">NULL</span>;</span><br><span class="line">  sa.sa_flags     = SA_RESTART;</span><br><span class="line">  sa.sa_sigaction = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  sigemptyset(&amp;sa.sa_mask);<span class="comment">//初始化mask为空</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Various ways of saying &quot;stop&quot;. */</span></span><br><span class="line">  <span class="comment">/*&#x27;stop&#x27;情况的处理*/</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_stop_sig;</span><br><span class="line">  sigaction(SIGHUP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  sigaction(SIGINT, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  sigaction(SIGTERM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Exec timeout notifications. */</span></span><br><span class="line">  <span class="comment">/*超时情况的处理*/</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_timeout;</span><br><span class="line">  sigaction(SIGALRM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Window resize */</span></span><br><span class="line">  <span class="comment">/*窗口大小的处理*/</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_resize;</span><br><span class="line">  sigaction(SIGWINCH, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* SIGUSR1: skip entry */</span></span><br><span class="line">  <span class="comment">/*自定义信号处理*/</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_skipreq;</span><br><span class="line">  sigaction(SIGUSR1, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Things we don&#x27;t care about. */</span></span><br><span class="line">  <span class="comment">/*一些不是很重要的信号的处理*/</span></span><br><span class="line">  </span><br><span class="line">  sa.sa_handler = SIG_IGN;</span><br><span class="line">  sigaction(SIGTSTP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  sigaction(SIGPIPE, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_stop_sig</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//设置stop_soon为1</span></span><br><span class="line">  stop_soon = <span class="number">1</span>; </span><br><span class="line">  <span class="comment">//child_pid存在，发送SIGKILL信号，从而被系统杀死</span></span><br><span class="line">  <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) kill(child_pid, SIGKILL);</span><br><span class="line">  <span class="comment">//forksrv_pid存在，同理</span></span><br><span class="line">  <span class="keyword">if</span> (forksrv_pid &gt; <span class="number">0</span>) kill(forksrv_pid, SIGKILL);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_timeout</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//如果child_pid存在</span></span><br><span class="line">  <span class="keyword">if</span> (child_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//设置child_timed_out为1，并kill掉child_pid</span></span><br><span class="line">    child_timed_out = <span class="number">1</span>; </span><br><span class="line">    kill(child_pid, SIGKILL);</span><br><span class="line">  <span class="comment">//如果child_pid不存在且forksrv_pid&gt;0</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child_pid == <span class="number">-1</span> &amp;&amp; forksrv_pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//设置child_timed_out为1，并kill掉forksrv_pid</span></span><br><span class="line">    child_timed_out = <span class="number">1</span>; </span><br><span class="line">    kill(forksrv_pid, SIGKILL);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_resize</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">  clear_screen = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_skipreq</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  skip_requested = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts()"></a>check_asan_opts()</h2><p>读取环境变量<code>ASAN_OPTIONS</code>和<code>MSAN_OPTIONS</code>，并做相应的检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">check_asan_opts</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  u8* x = getenv(<span class="string">&quot;ASAN_OPTIONS&quot;</span>);<span class="comment">//读取ASAN_OPTIONS</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line">    <span class="comment">//检查abort_on_error是否为1，不为1报错</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;abort_on_error=1&quot;</span>))</span><br><span class="line">      FATAL(<span class="string">&quot;Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      FATAL(<span class="string">&quot;Custom ASAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;<span class="comment">//ASAN_OPTIONS情况</span></span><br><span class="line"></span><br><span class="line">  x = getenv(<span class="string">&quot;MSAN_OPTIONS&quot;</span>);<span class="comment">//读取MSAN_OPTIONS</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line">    <span class="comment">//检查exit_code对应的状态码是否设置，没有报错</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;exit_code=&quot;</span> STRINGIFY(MSAN_ERROR)))</span><br><span class="line">      FATAL(<span class="string">&quot;Custom MSAN_OPTIONS set without exit_code=&quot;</span></span><br><span class="line">            STRINGIFY(MSAN_ERROR) <span class="string">&quot; - please fix!&quot;</span>);</span><br><span class="line">    <span class="comment">//检查symbolize是否为0，没有报错</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      FATAL(<span class="string">&quot;Custom MSAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;<span class="comment">//MSAN_OPTIONS情况</span></span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync()"></a>fix_up_sync()</h2><p>如果通过 <code>-M</code>或者<code>-S</code>指定了 <code>sync_id</code>，则更新 <code>out_dir</code> 和 <code>sync_dir</code> 的值：设置 <code>sync_dir</code> 的值为 <code>out_dir</code>，设置 <code>out_dir</code> 的值为<code>out_dir/sync_id</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fix_up_sync</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* x = sync_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode)<span class="comment">////如果在设置dumb_mode模式，提示-S / -M参数与 -n参数互斥</span></span><br><span class="line">    FATAL(<span class="string">&quot;-S / -M and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic) &#123;</span><br><span class="line">    <span class="comment">//如果force_deterministic已设置，检查参数是否互斥</span></span><br><span class="line">    <span class="keyword">if</span> (force_deterministic)</span><br><span class="line">      FATAL(<span class="string">&quot;use -S instead of -M -d&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      FATAL(<span class="string">&quot;-S already implies -d&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (*x) &#123;</span><br><span class="line">    <span class="comment">//ID纠正</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(*x) &amp;&amp; *x != <span class="string">&#x27;_&#x27;</span> &amp;&amp; *x != <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">      FATAL(<span class="string">&quot;Non-alphanumeric fuzzer ID specified via -S or -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">    x++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//sync_id过长报错</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(sync_id) &gt; <span class="number">32</span>) FATAL(<span class="string">&quot;Fuzzer ID too long&quot;</span>);</span><br><span class="line"></span><br><span class="line">  x = alloc_printf(<span class="string">&quot;%s/%s&quot;</span>, out_dir, sync_id);</span><br><span class="line">  <span class="comment">//更新sync_dir和out_dir的值</span></span><br><span class="line">  sync_dir = out_dir;</span><br><span class="line">  out_dir  = x;</span><br><span class="line">  <span class="comment">//如果force_deterministic没设置，赋值</span></span><br><span class="line">  <span class="keyword">if</span> (!force_deterministic) &#123;</span><br><span class="line">    skip_deterministic = <span class="number">1</span>;</span><br><span class="line">    use_splicing = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="save-cmdline"><a href="#save-cmdline" class="headerlink" title="save_cmdline()"></a>save_cmdline()</h2><p>Copy 当前命令行参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save_cmdline</span><span class="params">(u32 argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 len = <span class="number">1</span>, i;</span><br><span class="line">  u8* buf;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//遍历参数算出长度</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">    len += <span class="built_in">strlen</span>(argv[i]) + <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//为buf参数开辟存储空间</span></span><br><span class="line">  buf = orig_cmdline = ck_alloc(len);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//将参数拷贝进buf</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">    <span class="comment">//计算当前argv[i]长度</span></span><br><span class="line">    u32 l = <span class="built_in">strlen</span>(argv[i]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, argv[i], l);</span><br><span class="line">    buf += l;</span><br><span class="line">    <span class="comment">//判断后面是否还有参数</span></span><br><span class="line">    <span class="keyword">if</span> (i != argc - <span class="number">1</span>) *(buf++) = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//结尾赋0</span></span><br><span class="line">  *buf = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="fix-up-banner"><a href="#fix-up-banner" class="headerlink" title="fix_up_banner()"></a>fix_up_banner()</h2><p>获取目标程序名称或程序路径或路径+省略号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fix_up_banner</span><span class="params">(u8* name)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//如果没有设置use_banner</span></span><br><span class="line">  <span class="keyword">if</span> (!use_banner) &#123;</span><br><span class="line">    <span class="comment">//如果设置了sync_id，赋值</span></span><br><span class="line">    <span class="keyword">if</span> (sync_id) &#123;</span><br><span class="line">      <span class="comment">//赋值</span></span><br><span class="line">      use_banner = sync_id;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//获取参数最后一个&#x27;/&#x27;后面的内容，即最终文件名</span></span><br><span class="line">      u8* trim = <span class="built_in">strrchr</span>(name, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">      <span class="comment">//如果没获取到，把文件目录赋给use_banner</span></span><br><span class="line">      <span class="keyword">if</span> (!trim) use_banner = name; </span><br><span class="line">      <span class="comment">//如果获取到了，把最终文件名去掉&#x27;/&#x27;并赋给use_banner</span></span><br><span class="line">      <span class="keyword">else</span> use_banner = trim + <span class="number">1</span>;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//如果use_banner太长</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(use_banner) &gt; <span class="number">40</span>) &#123;</span><br><span class="line">    <span class="comment">//创建一个44字长的tmp变量</span></span><br><span class="line">    u8* tmp = ck_alloc(<span class="number">44</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(tmp, <span class="string">&quot;%.40s...&quot;</span>, use_banner);</span><br><span class="line">    <span class="comment">//将tmp赋给use_banner</span></span><br><span class="line">    use_banner = tmp;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty()"></a>check_if_tty()</h2><p>检查是否在 tty 终端上面运行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">check_if_tty</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">ws</span>;</span></span><br><span class="line">  <span class="comment">//如果读取到了环境变量AFL_NO_UI</span></span><br><span class="line">  <span class="keyword">if</span> (getenv(<span class="string">&quot;AFL_NO_UI&quot;</span>)) &#123;</span><br><span class="line">    OKF(<span class="string">&quot;Disabling the UI because AFL_NO_UI is set.&quot;</span>);</span><br><span class="line">    not_on_tty = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//通过ioctl读取window size</span></span><br><span class="line">  <span class="keyword">if</span> (ioctl(<span class="number">1</span>, TIOCGWINSZ, &amp;ws)) &#123;</span><br><span class="line">    <span class="comment">//如果报错为ENOTTY，说明当前不在一个tty终端运行</span></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOTTY) &#123;</span><br><span class="line">      OKF(<span class="string">&quot;Looks like we&#x27;re not running on a tty, so I&#x27;ll be a bit less verbose.&quot;</span>);</span><br><span class="line">      not_on_tty = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="几个CPU检查相关的函数"><a href="#几个CPU检查相关的函数" class="headerlink" title="几个CPU检查相关的函数"></a>几个CPU检查相关的函数</h2><ul>
<li><p><code>get_core_count()</code>：获取 CPU 数量</p>
</li>
<li><p><code>check_crash_handling()</code>：确保核心转储不会进入程序</p>
</li>
<li><p><code>check_cpu_governor()</code>：检查CPU管理者</p>
</li>
</ul>
<h2 id="setup-post"><a href="#setup-post" class="headerlink" title="setup_post()"></a>setup_post()</h2><p>如果设置<code>AFL_POST_LIBRARY</code>环境变量，则加载 afl_postprocess() 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup_post</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span>* dh;</span><br><span class="line">  <span class="comment">//获取环境变量AFL_POST_LIBRARY</span></span><br><span class="line">  u8* fn = getenv(<span class="string">&quot;AFL_POST_LIBRARY&quot;</span>);</span><br><span class="line">  u32 tlen = <span class="number">6</span>;</span><br><span class="line">  <span class="comment">//如果没获取到，返回</span></span><br><span class="line">  <span class="keyword">if</span> (!fn) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  ACTF(<span class="string">&quot;Loading postprocessor from &#x27;%s&#x27;...&quot;</span>, fn);</span><br><span class="line">  <span class="comment">//以RTLD_NOW模式打开AFL_POST_LIBRARY指向的动态链接库，在返回前解析出所有未定义的符号</span></span><br><span class="line">  dh = dlopen(fn, RTLD_NOW);</span><br><span class="line">  <span class="keyword">if</span> (!dh) FATAL(<span class="string">&quot;%s&quot;</span>, dlerror());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//动态链接库中afl_postprocess()函数地址赋给post_handler</span></span><br><span class="line">  post_handler = dlsym(dh, <span class="string">&quot;afl_postprocess&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!post_handler) FATAL(<span class="string">&quot;Symbol &#x27;afl_postprocess&#x27; not found.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do a quick test. It&#x27;s better to segfault now than later =) */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//afl_postprocess()函数测试</span></span><br><span class="line">  post_handler(<span class="string">&quot;hello&quot;</span>, &amp;tlen);</span><br><span class="line"></span><br><span class="line">  OKF(<span class="string">&quot;Postprocessor installed successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="setup-shm-（very-important）"><a href="#setup-shm-（very-important）" class="headerlink" title="setup_shm()（very important）"></a>setup_shm()（very important）</h2><p>用于设置共享内存和 <code>virgin_bits</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="keyword">void</span> <span class="title">setup_shm</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* shm_str;</span><br><span class="line">  <span class="comment">//如果in_bitmap为空，初始化virgin_bits[MAP_SIZE]每个值为255</span></span><br><span class="line">  <span class="keyword">if</span> (!in_bitmap) <span class="built_in">memset</span>(virgin_bits, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//初始化</span></span><br><span class="line">  <span class="built_in">memset</span>(virgin_tmout, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">  <span class="built_in">memset</span>(virgin_crash, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//调用 shmget 函数分配一块共享内存，并将返回的共享内存标识符保存到 shm_id</span></span><br><span class="line">  shm_id = shmget(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | <span class="number">0600</span>);</span><br><span class="line">  <span class="comment">/*函数的第一个参数：程序需要提供一个key,为共享内存段命名shmget()函数成功时返回一个与key相关的共享内存标识符（非负整数），</span></span><br><span class="line"><span class="comment">  用于后续的共享内存函数。调用失败返回-1。</span></span><br><span class="line"><span class="comment">    函数的第二个参数：需要共享的内存容量，这里大小为MAP_SIZE</span></span><br><span class="line"><span class="comment">    函数的第三个参数：权限标志</span></span><br><span class="line"><span class="comment">      IPC_CREAT 如果共享内存不存在，则创建一个共享内存</span></span><br><span class="line"><span class="comment">      IPC_EXCL 只有在共享内存不存在的时候，新的共享内存才建立，否则就产生错误</span></span><br><span class="line"><span class="comment">      0060代表拥有者具有读写权限</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//如果没有获得共享内存标识符，即共享内存创建失败，报错</span></span><br><span class="line">  <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;shmget() failed&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//注册程序正常终止时删除共享内存</span></span><br><span class="line">  atexit(remove_shm);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建shm_str字符串变量，里面存放shm_id</span></span><br><span class="line">  shm_str = alloc_printf(<span class="string">&quot;%d&quot;</span>, shm_id);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If somebody is asking us to fuzz instrumented binaries in dumb mode,</span></span><br><span class="line"><span class="comment">     we don&#x27;t want them to detect instrumentation, since we won&#x27;t be sending</span></span><br><span class="line"><span class="comment">     fork server commands. This should be replaced with better auto-detection</span></span><br><span class="line"><span class="comment">     later on, perhaps? */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果不是dumb模式，则设置SHM_ENV_VAR为shm_str</span></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode) setenv(SHM_ENV_VAR, shm_str, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//释放shm_str指针</span></span><br><span class="line">  ck_free(shm_str);</span><br><span class="line"></span><br><span class="line">  trace_bits = shmat(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">/*启动对该共享内存的访问，将共享内存的首地址赋给trace_bits，并把共享内存连接到当前进程的地址空间</span></span><br><span class="line"><span class="comment">    第一个参数，shm_id是由shmget()函数返回的共享内存标识</span></span><br><span class="line"><span class="comment">    第二个参数，指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址</span></span><br><span class="line"><span class="comment">    第三个参数，标志位，通常为0*/</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//共享内存访问启动失败，报错</span></span><br><span class="line">  <span class="keyword">if</span> (!trace_bits) PFATAL(<span class="string">&quot;shmat() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove_shm</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  shmctl(shm_id, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">/*函数用来控制共享内存</span></span><br><span class="line"><span class="comment">    第一个参数，shm_id是shmget()函数返回的共享内存标识符</span></span><br><span class="line"><span class="comment">    第二个参数，IPC_RMID：删除共享内存段</span></span><br><span class="line"><span class="comment">    第三个参数，指向共享内存模式和访问权限的结构，这里指向NULL*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="init-count-class16"><a href="#init-count-class16" class="headerlink" title="init_count_class16()"></a>init_count_class16()</h2><p>统计 AFL 遍历路径的次数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> u8 count_class_lookup8[<span class="number">256</span>] = &#123;</span><br><span class="line"><span class="comment">/*记录路径命中次数，因为可能循环5次和循环6次造成的效果一样，所以把它们统一认为是循环了8次*/</span></span><br><span class="line">  [<span class="number">0</span>]           = <span class="number">0</span>,</span><br><span class="line">  [<span class="number">1</span>]           = <span class="number">1</span>,</span><br><span class="line">  [<span class="number">2</span>]           = <span class="number">2</span>,</span><br><span class="line">  [<span class="number">3</span>]           = <span class="number">4</span>,</span><br><span class="line">  [<span class="number">4</span> ... <span class="number">7</span>]     = <span class="number">8</span>,</span><br><span class="line">  [<span class="number">8</span> ... <span class="number">15</span>]    = <span class="number">16</span>,</span><br><span class="line">  [<span class="number">16</span> ... <span class="number">31</span>]   = <span class="number">32</span>,</span><br><span class="line">  [<span class="number">32</span> ... <span class="number">127</span>]  = <span class="number">64</span>,</span><br><span class="line">  [<span class="number">128</span> ... <span class="number">255</span>] = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> u16 count_class_lookup16[<span class="number">65536</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="keyword">void</span> <span class="title">init_count_class16</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 b1, b2;</span><br><span class="line">  <span class="comment">//将count_class_lookup16[65536]拆分成两个嵌套的256次循环，256x256=65536</span></span><br><span class="line">  <span class="keyword">for</span> (b1 = <span class="number">0</span>; b1 &lt; <span class="number">256</span>; b1++) </span><br><span class="line">    <span class="keyword">for</span> (b2 = <span class="number">0</span>; b2 &lt; <span class="number">256</span>; b2++)</span><br><span class="line">    <span class="comment">/*count_class_lookup8[b1]左移8的结果和count_class_lookup8[b2]进行按位或运算，</span></span><br><span class="line"><span class="comment">      再把整个结果放在 count_class_lookup8[b1左移8再加上b2] 中*/</span></span><br><span class="line">      count_class_lookup16[(b1 &lt;&lt; <span class="number">8</span>) + b2] = </span><br><span class="line">        (count_class_lookup8[b1] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">        count_class_lookup8[b2];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="setup-dirs-fds"><a href="#setup-dirs-fds" class="headerlink" title="setup_dirs_fds()"></a>setup_dirs_fds()</h2><p>准备输出文件夹和文件描述符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Prepare output directories and fds. */</span></span><br><span class="line"><span class="function">EXP_ST <span class="keyword">void</span> <span class="title">setup_dirs_fds</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* tmp;</span><br><span class="line">  s32 fd;</span><br><span class="line"></span><br><span class="line">  ACTF(<span class="string">&quot;Setting up output directories...&quot;</span>);</span><br><span class="line">  <span class="comment">/*如果sync_id存在，创建文件夹sync_dir，权限设置为0700(读写执行)</span></span><br><span class="line"><span class="comment">    且errno != EEXIST，抛出异常*/</span></span><br><span class="line">  <span class="keyword">if</span> (sync_id &amp;&amp; mkdir(sync_dir, <span class="number">0700</span>) &amp;&amp; errno != EEXIST)</span><br><span class="line">      PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, sync_dir);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//如果创建文件夹out_dir，且权限设置为0700成功</span></span><br><span class="line">  <span class="keyword">if</span> (mkdir(out_dir, <span class="number">0700</span>)) &#123;</span><br><span class="line">    <span class="comment">//如果errno != EEXIST，抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (errno != EEXIST) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, out_dir);</span><br><span class="line">    <span class="comment">//调用函数</span></span><br><span class="line">    maybe_delete_out_dir();</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;<span class="comment">//如果创建文件夹out_dir失败</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果设置了in_place_resume，抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (in_place_resume)</span><br><span class="line">      FATAL(<span class="string">&quot;Resume attempted but old output directory not found&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//以只读模式打开文件并将句柄赋值给out_dir_fd</span></span><br><span class="line">    out_dir_fd = open(out_dir, O_RDONLY);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __sun<span class="comment">//如果没有定义宏__sun</span></span></span><br><span class="line">    <span class="comment">//如果out_dir文件打开失败，或out_dir文件简历互斥锁定失败，抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (out_dir_fd &lt; <span class="number">0</span> || flock(out_dir_fd, LOCK_EX | LOCK_NB))</span><br><span class="line">      PFATAL(<span class="string">&quot;Unable to flock() output directory.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* !__sun */</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//创建 queue 文件夹</span></span><br><span class="line">  <span class="comment">/* Queue directory for any starting &amp; discovered paths. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 out_dir/queue 文件夹，设置权限为0700</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/queue&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Top-level directory for queue metadata used for session</span></span><br><span class="line"><span class="comment">     resume and related tasks. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//创建out_dir/queue/.state/,设置权限为0700</span></span><br><span class="line">  <span class="comment">//该文件夹主要保存用于session resume和related tasks的队列元数据</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/queue/.state/&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Directory for flagging queue entries that went through</span></span><br><span class="line"><span class="comment">     deterministic fuzzing in the past. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//创建out_dir/queue/.state/deterministic_done/,设置权限为0700</span></span><br><span class="line">  <span class="comment">//用于标记过去经历过deterministic fuzzing的队列条目</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/queue/.state/deterministic_done/&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Directory with the auto-selected dictionary entries. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//创建out_dir/queue/.state/auto_extras/,设置权限为0700</span></span><br><span class="line">  <span class="comment">//用于保存带有自动选择的字典条目</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/queue/.state/auto_extras/&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The set of paths currently deemed redundant. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">//创建out_dir/queue/.state/redundant_edges/,设置权限为0700</span></span><br><span class="line">  <span class="comment">//用于保存当前被认为是多余的路径集合</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/queue/.state/redundant_edges/&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The set of paths showing variable behavior. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建out_dir/queue/.state/variable_behavior/,设置权限为0700</span></span><br><span class="line">  <span class="comment">//保存不同行为的路径集</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/queue/.state/variable_behavior/&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sync directory for keeping track of cooperating fuzzers. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//如果sync_id存在</span></span><br><span class="line">  <span class="keyword">if</span> (sync_id) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建out_dir/.synced/，设置权限为0700</span></span><br><span class="line">    <span class="comment">//做目录同步，该目录用于跟踪cooperating fuzzers</span></span><br><span class="line">    tmp = alloc_printf(<span class="string">&quot;%s/.synced/&quot;</span>, out_dir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>) &amp;&amp; (!in_place_resume || errno != EEXIST))</span><br><span class="line">      PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line"></span><br><span class="line">    ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* All recorded crashes. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建 out_dir/crashes/ 目录,设置权限为读写执行‘</span></span><br><span class="line">  <span class="comment">//记录crash</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/crashes&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* All recorded hangs. */</span></span><br><span class="line"></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/hangs&quot;</span>, out_dir);</span><br><span class="line">  <span class="keyword">if</span> (mkdir(tmp, <span class="number">0700</span>)) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Generally useful file descriptors. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//用读写的方式打开/dev/null，打不开报错</span></span><br><span class="line">  dev_null_fd = open(<span class="string">&quot;/dev/null&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_null_fd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to open /dev/null&quot;</span>);</span><br><span class="line">  <span class="comment">//用只读方式打开/dev/urandom，打不开报错</span></span><br><span class="line">  dev_urandom_fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (dev_urandom_fd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to open /dev/urandom&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Gnuplot output file. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//以只写方式打开out_dir/plot_data文件，如果文件不存在就创建，返回句柄fd</span></span><br><span class="line">  tmp = alloc_printf(<span class="string">&quot;%s/plot_data&quot;</span>, out_dir);</span><br><span class="line">  fd = open(tmp, O_WRONLY | O_CREAT | O_EXCL, <span class="number">0600</span>);</span><br><span class="line">  <span class="comment">/*O_CREAT:如果指定文件不存在，则创建这个文件</span></span><br><span class="line"><span class="comment">    O_EXCL :如果要创建的文件已存在，则返回 -1，并且修改 errno 的值*/</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to create &#x27;%s&#x27;&quot;</span>, tmp);</span><br><span class="line">  ck_free(tmp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//根据句柄得到FILE结构体指针plot_file</span></span><br><span class="line">  plot_file = fdopen(fd, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!plot_file) PFATAL(<span class="string">&quot;fdopen() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(plot_file, <span class="string">&quot;# unix_time, cycles_done, cur_path, paths_total, &quot;</span></span><br><span class="line">                     <span class="string">&quot;pending_total, pending_favs, map_size, unique_crashes, &quot;</span></span><br><span class="line">                     <span class="string">&quot;unique_hangs, max_depth, execs_per_sec\n&quot;</span>);</span><br><span class="line">                     <span class="comment">/* ignore errors */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases()"></a>read_testcases()</h2><p>从输入文件夹中读取所有文件，然后将它们排队进行测试。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read_testcases</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> **<span class="title">nl</span>;</span></span><br><span class="line">  s32 nl_cnt;</span><br><span class="line">  u32 i;</span><br><span class="line">  u8* fn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Auto-detect non-in-place resumption attempts. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//访问in_dir/queue文件夹，如果存在就设置in_dir为in_dir/queue</span></span><br><span class="line">  fn = alloc_printf(<span class="string">&quot;%s/queue&quot;</span>, in_dir);</span><br><span class="line">  <span class="keyword">if</span> (!access(fn, F_OK)) in_dir = fn; <span class="keyword">else</span> ck_free(fn);</span><br><span class="line"></span><br><span class="line">  ACTF(<span class="string">&quot;Scanning &#x27;%s&#x27;...&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We use scandir() + alphasort() rather than readdir() because otherwise,</span></span><br><span class="line"><span class="comment">     the ordering  of test cases would vary somewhat randomly and would be</span></span><br><span class="line"><span class="comment">     difficult to control. */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//扫描in_dir，并将扫描结果排好序后放入nl，匹配到的文件个数存储在nl_cnt中</span></span><br><span class="line">  nl_cnt = scandir(in_dir, &amp;nl, <span class="literal">NULL</span>, alphasort);</span><br><span class="line">  <span class="comment">/*第一个参数：扫描的路径</span></span><br><span class="line"><span class="comment">    第二个参数：扫描结果保存的列表</span></span><br><span class="line"><span class="comment">    第三个参数：指向过滤函数，对参数一进行过滤，如果是NULL,则扫描一参目录下的所有顶层文件</span></span><br><span class="line"><span class="comment">    第四个参数：将过滤后的结果进行排序*/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果没有扫描到匹配文件</span></span><br><span class="line">  <span class="keyword">if</span> (nl_cnt &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOENT || errno == ENOTDIR)</span><br><span class="line"></span><br><span class="line">      SAYF(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;The input directory does not seem to be valid - try again. The fuzzer needs\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    one or more test case to start with - ideally, a small file under 1 kB\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    or so. The cases must be stored as regular files directly in the input\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    PFATAL(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//如果设置了shuffle_queue，且扫描到了匹配文件</span></span><br><span class="line">  <span class="keyword">if</span> (shuffle_queue &amp;&amp; nl_cnt &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    ACTF(<span class="string">&quot;Shuffling queue...&quot;</span>);</span><br><span class="line">    <span class="comment">//利用shuffle_ptrs函数重排nl里的指针位置</span></span><br><span class="line">    shuffle_ptrs((<span class="keyword">void</span>**)nl, nl_cnt);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//遍历nl,nl[i]-&gt;d_name的值为input文件夹下的文件名,例如a.out</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nl_cnt; i++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="comment">//目录</span></span><br><span class="line">    u8* fn = alloc_printf(<span class="string">&quot;%s/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line">    u8* dfn = alloc_printf(<span class="string">&quot;%s/.state/deterministic_done/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line"></span><br><span class="line">    u8  passed_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(nl[i]); <span class="comment">/* not tracked */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从fn获取文件信息并保存在st中，检测目录是否可以访问，访问不了报错</span></span><br><span class="line">    <span class="keyword">if</span> (lstat(fn, &amp;st) || access(fn, R_OK))</span><br><span class="line">      PFATAL(<span class="string">&quot;Unable to access &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This also takes care of . and .. */</span></span><br><span class="line">    <span class="comment">//判断st.st_mode是否是一个常规文件，st.st_size确定文件大小，strstr匹配文件是否是README.txt</span></span><br><span class="line">    <span class="comment">//排除干扰文件，如.或..或README</span></span><br><span class="line">    <span class="keyword">if</span> (!S_ISREG(st.st_mode) || !st.st_size || <span class="built_in">strstr</span>(fn, <span class="string">&quot;/README.txt&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      ck_free(fn);</span><br><span class="line">      ck_free(dfn);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果是有效文件，检查文件大小是否超过规定值界限，默认1024*1024字节，即1M</span></span><br><span class="line">    <span class="keyword">if</span> (st.st_size &gt; MAX_FILE) </span><br><span class="line">      FATAL(<span class="string">&quot;Test case &#x27;%s&#x27; is too big (%s, limit is %s)&quot;</span>, fn,</span><br><span class="line">            DMS(st.st_size), DMS(MAX_FILE));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for metadata that indicates that deterministic fuzzing</span></span><br><span class="line"><span class="comment">       is complete for this entry. We don&#x27;t want to repeat deterministic</span></span><br><span class="line"><span class="comment">       fuzzing when resuming aborted scans, because it would be pointless</span></span><br><span class="line"><span class="comment">       and probably very time-consuming. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查dfn是否创建成功，即in_dir/.state/deterministic_done/nl[i]-&gt;d_name</span></span><br><span class="line">    <span class="keyword">if</span> (!access(dfn, F_OK)) passed_det = <span class="number">1</span>;</span><br><span class="line">    ck_free(dfn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将fd文件入队</span></span><br><span class="line">    add_to_queue(fn, st.st_size, passed_det);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(nl); <span class="comment">/* not tracked */</span></span><br><span class="line">  <span class="comment">//如果没有入队的输入文件</span></span><br><span class="line">  <span class="keyword">if</span> (!queued_paths) &#123;</span><br><span class="line"></span><br><span class="line">    SAYF(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">         <span class="string">&quot;Looks like there are no valid test cases in the input directory! The fuzzer\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    needs one or more test case to start with - ideally, a small file under\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    1 kB or so. The cases must be stored as regular files directly in the\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    input directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FATAL(<span class="string">&quot;No usable test cases in &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  last_path_time = <span class="number">0</span>;</span><br><span class="line">  queued_at_start = queued_paths;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto()"></a>load_auto()</h2><p>load自动生成的提取出来的词典token</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">load_auto</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i;</span><br><span class="line">  <span class="comment">//循环遍历从0到USE_AUTO_EXTRAS，默认50</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; USE_AUTO_EXTRAS; i++) &#123;</span><br><span class="line"></span><br><span class="line">    u8  tmp[MAX_AUTO_EXTRA + <span class="number">1</span>];</span><br><span class="line">    u8* fn = alloc_printf(<span class="string">&quot;%s/.state/auto_extras/auto_%06u&quot;</span>, in_dir, i);</span><br><span class="line">    s32 fd, len;</span><br><span class="line">    <span class="comment">//以只读的方式打开fn获得句柄fd</span></span><br><span class="line">    fd = open(fn, O_RDONLY, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开失败报错</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (errno != ENOENT) PFATAL(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line">      ck_free(fn);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We read one byte more to cheaply detect tokens that are too</span></span><br><span class="line"><span class="comment">       long (and skip them). */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//从fd读取MAX_AUTO_EXTRA + 1个字节到tmp中</span></span><br><span class="line">    <span class="comment">//MAX_AUTO_EXTRA默认32，是最大大小，+1判断读取是否过长</span></span><br><span class="line">    len = read(fd, tmp, MAX_AUTO_EXTRA + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//没读取到报错</span></span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) PFATAL(<span class="string">&quot;Unable to read from &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line">    <span class="comment">/*如果读取的长度在MIN_AUTO_EXTRA(3)和MAX_AUTO_EXTRA(32)之间</span></span><br><span class="line"><span class="comment">      调用maybe_add_auto函数*/</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt;= MIN_AUTO_EXTRA &amp;&amp; len &lt;= MAX_AUTO_EXTRA)</span><br><span class="line">      maybe_add_auto(tmp, len);</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    ck_free(fn);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i) OKF(<span class="string">&quot;Loaded %u auto-discovered dictionary tokens.&quot;</span>, i);</span><br><span class="line">  <span class="keyword">else</span> OKF(<span class="string">&quot;No auto-generated dictionary tokens to reuse.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">home</a></li>
         
          <li><a href="/about/">about</a></li>
         
          <li><a href="/archives/">articles</a></li>
         
          <li><a href="/categories/">category</a></li>
         
          <li><a href="/link/">link</a></li>
         
          <li><a href="/search/">search</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/makabaka-yyds/makabaka-yyds.github.io">projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-signal-handlers"><span class="toc-number">2.</span> <span class="toc-text">setup_signal_handlers()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#check-asan-opts"><span class="toc-number">3.</span> <span class="toc-text">check_asan_opts()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fix-up-sync"><span class="toc-number">4.</span> <span class="toc-text">fix_up_sync()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#save-cmdline"><span class="toc-number">5.</span> <span class="toc-text">save_cmdline()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fix-up-banner"><span class="toc-number">6.</span> <span class="toc-text">fix_up_banner()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#check-if-tty"><span class="toc-number">7.</span> <span class="toc-text">check_if_tty()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%A0%E4%B8%AACPU%E6%A3%80%E6%9F%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">几个CPU检查相关的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-post"><span class="toc-number">9.</span> <span class="toc-text">setup_post()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-shm-%EF%BC%88very-important%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">setup_shm()（very important）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-count-class16"><span class="toc-number">11.</span> <span class="toc-text">init_count_class16()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setup-dirs-fds"><span class="toc-number">12.</span> <span class="toc-text">setup_dirs_fds()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#read-testcases"><span class="toc-number">13.</span> <span class="toc-text">read_testcases()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load-auto"><span class="toc-number">14.</span> <span class="toc-text">load_auto()</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&text=AFL源码分析之afl-fuzz.c"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&is_video=false&description=AFL源码分析之afl-fuzz.c"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AFL源码分析之afl-fuzz.c&body=Check out this article: http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&title=AFL源码分析之afl-fuzz.c"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&name=AFL源码分析之afl-fuzz.c&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://makabaka-yyds.github.io/2022/03/08/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bafl-fuzz-c/&t=AFL源码分析之afl-fuzz.c"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2022
    Xu4n
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">home</a></li><!--
     --><!--
       --><li><a href="/about/">about</a></li><!--
     --><!--
       --><li><a href="/archives/">articles</a></li><!--
     --><!--
       --><li><a href="/categories/">category</a></li><!--
     --><!--
       --><li><a href="/link/">link</a></li><!--
     --><!--
       --><li><a href="/search/">search</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/makabaka-yyds/makabaka-yyds.github.io">projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
